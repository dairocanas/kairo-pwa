<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>KAIRO IA Personal ‚Äî PWA (Voz + Google Calendar)</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#00ffd1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google APIs (Calendar) -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    :root{ --bg:#0b0f14; }
    body{background:var(--bg)}
    .glass{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); backdrop-filter: blur(8px);}
    .neon{box-shadow:0 0 0 1px rgba(0,255,209,.15), 0 0 20px rgba(0,255,209,.12) inset;}
    .grid-auto{grid-template-columns: repeat(auto-fill, minmax(260px,1fr));}
    .calendar-day{cursor:pointer}
  </style>
</head>
<body class="text-slate-100">
  <div class="max-w-7xl mx-auto p-4 md:p-8">
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <img src="assets/icon-192.png" class="w-10 h-10 rounded-lg" alt="KAIRO">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold">KAIRO IA Personal ‚Äî PWA</h1>
          <p class="text-xs md:text-sm text-slate-400">Instalable ‚Ä¢ Offline ‚Ä¢ Notificaciones con sonido ‚Ä¢ Comandos de voz ‚Ä¢ Google Calendar</p>
        </div>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="installBtn" class="hidden bg-slate-900 px-3 py-1 rounded-lg text-sm">Instalar</button>
        <button id="notifyBtn" class="bg-slate-900 px-3 py-1 rounded-lg text-sm">Activar notificaciones</button>
        <button id="micBtn" class="bg-slate-900 px-3 py-1 rounded-lg text-sm">üéôÔ∏è Voz</button>
        <button id="googleBtn" class="bg-violet-700 px-3 py-1 rounded-lg text-sm">Conectar Google Calendar</button>
      </div>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <button id="addTaskBtn" class="glass neon rounded-2xl p-4 flex justify-between items-center">
        <div><div class="text-sm text-slate-400">R√°pido</div><div class="font-semibold">A√±adir tarea</div></div>
        <div class="w-9 h-9 rounded-full border border-cyan-400 flex items-center justify-center">+</div>
      </button>
      <button id="addEventBtn" class="glass neon rounded-2xl p-4 flex justify-between items-center">
        <div><div class="text-sm text-slate-400">Agenda</div><div class="font-semibold">Nuevo evento</div></div>
        <div class="w-9 h-9 rounded-full border border-violet-400 flex items-center justify-center">üìÖ</div>
      </button>
      <button id="addNoteBtn" class="glass neon rounded-2xl p-4 flex justify-between items-center">
        <div><div class="text-sm text-slate-400">Notas</div><div class="font-semibold">Crear nota</div></div>
        <div class="w-9 h-9 rounded-full border border-cyan-400 flex items-center justify-center">üìù</div>
      </button>
    </section>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Calendario -->
      <section class="lg:col-span-2 glass neon rounded-2xl p-4 md:p-6">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-xl font-bold">Agenda</h2>
          <div class="flex items-center gap-2">
            <button id="prevMonth" class="px-3 py-1 rounded-lg bg-slate-800">‚óÄ</button>
            <div id="monthLabel" class="w-40 text-center"></div>
            <button id="nextMonth" class="px-3 py-1 rounded-lg bg-slate-800">‚ñ∂</button>
          </div>
        </div>
        <div class="grid grid-cols-7 text-center text-xs text-slate-400 mb-2">
          <div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div><div>Dom</div>
        </div>
        <div id="calendar" class="grid grid-cols-7 gap-2"></div>
        <div class="mt-4">
          <h3 class="text-sm text-slate-400 mb-2">Eventos del d√≠a <span id="selectedDateLabel" class="text-cyan-300"></span></h3>
          <ul id="eventsList" class="space-y-2"></ul>
        </div>
        <div class="mt-4">
          <h3 class="text-sm text-slate-400">Google Calendar</h3>
          <div id="gcalStatus" class="text-xs text-slate-400 mb-2">No conectado</div>
          <ul id="gcalUpcoming" class="space-y-2"></ul>
        </div>
      </section>

      <!-- Tareas -->
      <section class="glass neon rounded-2xl p-4 md:p-6">
        <h2 class="text-xl font-bold mb-3">Tareas</h2>
        <div class="flex gap-2 mb-3">
          <select id="filterStatus" class="bg-slate-900 rounded-lg px-2 py-1 text-sm">
            <option value="all">Todas</option>
            <option value="open">Abiertas</option>
            <option value="done">Completadas</option>
          </select>
          <select id="filterPriority" class="bg-slate-900 rounded-lg px-2 py-1 text-sm">
            <option value="all">Prioridad</option>
            <option value="alta">Alta</option>
            <option value="media">Media</option>
            <option value="baja">Baja</option>
          </select>
        </div>
        <ul id="tasksList" class="space-y-2"></ul>
      </section>

      <!-- Notas -->
      <section class="glass neon rounded-2xl p-4 md:p-6 lg:col-span-3">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-xl font-bold">Notas r√°pidas</h2>
          <div class="flex gap-2">
            <button id="exportBtn" class="bg-slate-900 px-3 py-1 rounded-lg text-sm">Exportar .json</button>
            <input type="file" id="importFile" class="hidden" accept="application/json">
            <button id="importBtn" class="bg-slate-900 px-3 py-1 rounded-lg text-sm">Importar .json</button>
          </div>
        </div>
        <div id="notesGrid" class="grid gap-3 grid-auto"></div>
      </section>
    </main>
  </div>

  <!-- Modales -->
  <div id="modalBackdrop" class="hidden fixed inset-0 bg-black/60"></div>

  <div id="taskModal" class="hidden fixed inset-0 flex items-center justify-center p-4">
    <div class="glass neon rounded-2xl p-6 max-w-md w-full">
      <h3 class="text-lg font-semibold mb-3">Nueva tarea</h3>
      <div class="space-y-3">
        <input id="taskTitle" class="w-full bg-slate-900 rounded-lg px-3 py-2" placeholder="T√≠tulo">
        <select id="taskPriority" class="w-full bg-slate-900 rounded-lg px-3 py-2">
          <option value="alta">Alta</option>
          <option value="media">Media</option>
          <option value="baja">Baja</option>
        </select>
        <input id="taskDue" type="datetime-local" class="w-full bg-slate-900 rounded-lg px-3 py-2">
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button class="px-3 py-1 bg-slate-800 rounded-lg" onclick="closeTaskModal()">Cancelar</button>
        <button class="px-3 py-1 bg-cyan-600 rounded-lg" onclick="saveTask()">Guardar</button>
      </div>
    </div>
  </div>

  <div id="eventModal" class="hidden fixed inset-0 flex items-center justify-center p-4">
    <div class="glass neon rounded-2xl p-6 max-w-md w-full">
      <h3 class="text-lg font-semibold mb-3">Nuevo evento</h3>
      <div class="space-y-3">
        <input id="eventTitle" class="w-full bg-slate-900 rounded-lg px-3 py-2" placeholder="T√≠tulo">
        <input id="eventDate" type="date" class="w-full bg-slate-900 rounded-lg px-3 py-2">
        <input id="eventTime" type="time" class="w-full bg-slate-900 rounded-lg px-3 py-2">
        <input id="eventPlace" class="w-full bg-slate-900 rounded-lg px-3 py-2" placeholder="Lugar (opcional)">
        <textarea id="eventNotes" class="w-full bg-slate-900 rounded-lg px-3 py-2" placeholder="Notas (opcional)"></textarea>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button class="px-3 py-1 bg-slate-800 rounded-lg" onclick="closeEventModal()">Cancelar</button>
        <button class="px-3 py-1 bg-violet-600 rounded-lg" onclick="saveEvent()">Guardar</button>
      </div>
    </div>
  </div>

  <div id="noteModal" class="hidden fixed inset-0 flex items-center justify-center p-4">
    <div class="glass neon rounded-2xl p-6 max-w-md w-full">
      <h3 class="text-lg font-semibold mb-3">Nueva nota</h3>
      <div class="space-y-3">
        <input id="noteTitle" class="w-full bg-slate-900 rounded-lg px-3 py-2" placeholder="T√≠tulo">
        <textarea id="noteBody" class="w-full bg-slate-900 rounded-lg px-3 py-2" rows="5" placeholder="Contenido"></textarea>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button class="px-3 py-1 bg-slate-800 rounded-lg" onclick="closeNoteModal()">Cancelar</button>
        <button class="px-3 py-1 bg-cyan-600 rounded-lg" onclick="saveNote()">Guardar</button>
      </div>
    </div>
  </div>

  <script>
    // ===== PWA install =====
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', (e)=>{ e.preventDefault(); deferredPrompt = e; installBtn.classList.remove('hidden'); });
    installBtn?.addEventListener('click', async ()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt=null; installBtn.classList.add('hidden'); });
    if('serviceWorker' in navigator){ navigator.serviceWorker.register('./sw.js'); }

    // ===== Notifications with SOUND =====
    const notifyBtn = document.getElementById('notifyBtn');
    notifyBtn.addEventListener('click', async ()=>{
      if(!('Notification' in window)) return alert('Notificaciones no soportadas');
      const p = await Notification.requestPermission();
      if(p !== 'granted') return alert('Activa permisos de notificaci√≥n.');
      alert('Notificaciones activadas.');
      scheduleAllReminders();
    });
    function playBeep(){
      try{
        const ctx = new (window.AudioContext||window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine'; o.frequency.value = 880;
        o.connect(g); g.connect(ctx.destination);
        g.gain.setValueAtTime(0.0001, ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
        g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.25);
        o.start(); o.stop(ctx.currentTime + 0.26);
      }catch(e){ /* ignore */ }
    }
    async function fire(title, body){
  if(Notification.permission !== 'granted') return;
  // Notificaci√≥n del sistema (suena aunque est√© en segundo plano)
  try {
    const reg = await navigator.serviceWorker.getRegistration();
    if (reg) {
      reg.showNotification(title, { body, icon: 'assets/icon-192.png' });
    } else {
      new Notification(title, { body, icon: 'assets/icon-192.png' });
    }
  } catch (e) {
    new Notification(title, { body, icon: 'assets/icon-192.png' });
  }
  // Beep adicional cuando la app est√° abierta
  try { playBeep(); } catch(e) {}
}
      }
    }

    // ===== Storage =====
    const LS = {
      get(key, fallback){ try{ return JSON.parse(localStorage.getItem(key)) ?? fallback } catch(e){ return fallback } },
      set(key, value){ localStorage.setItem(key, JSON.stringify(value)); }
    };
    const state = {
      tasks: LS.get('kairo_tasks', []),
      events: LS.get('kairo_events', []),
      notes: LS.get('kairo_notes', []),
      current: new Date()
    };
    function persist(){ LS.set('kairo_tasks', state.tasks); LS.set('kairo_events', state.events); LS.set('kairo_notes', state.notes); }

    // ===== Calendar =====
    const cal = { monthOffset: 0, selectedDate: new Date() };
    function startOfMonth(date){ return new Date(date.getFullYear(), date.getMonth(), 1); }
    function endOfMonth(date){ return new Date(date.getFullYear(), date.getMonth()+1, 0); }
    function sameDate(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }
    function renderCalendar(){
      const base = new Date(); base.setMonth(base.getMonth()+cal.monthOffset);
      const start = startOfMonth(base); const end = endOfMonth(base);
      const firstWeekDay = (start.getDay()+6)%7; const daysInMonth = end.getDate();
      const grid = document.getElementById('calendar'); grid.innerHTML = '';
      document.getElementById('monthLabel').textContent = base.toLocaleDateString('es-CO', {month:'long', year:'numeric'});
      const today = new Date();
      for(let i=0;i<firstWeekDay;i++){ grid.appendChild(document.createElement('div')); }
      for(let d=1; d<=daysInMonth; d++){
        const cell = document.createElement('button');
        cell.className = 'calendar-day rounded-lg p-2 bg-slate-900/40';
        const date = new Date(base.getFullYear(), base.getMonth(), d);
        const hasEvent = state.events.some(ev => sameDate(new Date(ev.date), date));
        cell.innerHTML = `<div class="flex items-center justify-between">
          <span class="text-sm ${sameDate(date,today)?'text-cyan-300 font-semibold':''}">${d}</span>
          ${hasEvent?'<span class="w-2 h-2 rounded-full bg-violet-400"></span>':''}
        </div>`;
        cell.onclick = ()=>{ cal.selectedDate = date; renderEventsForDay(); };
        grid.appendChild(cell);
      }
      cal.selectedDate = new Date(base.getFullYear(), base.getMonth(), (sameDate(base,today)? today.getDate():1));
      renderEventsForDay();
    }
    function renderEventsForDay(){
      const ul = document.getElementById('eventsList');
      const label = document.getElementById('selectedDateLabel');
      label.textContent = cal.selectedDate.toLocaleDateString('es-CO', {day:'2-digit', month:'long'});
      ul.innerHTML = '';
      const events = state.events.filter(ev => sameDate(new Date(ev.date), cal.selectedDate)).sort((a,b)=> (a.time||'').localeCompare(b.time||''));
      if(events.length===0){
        ul.innerHTML = '<li class="text-slate-400 text-sm">Sin eventos</li>';
      }else{
        events.forEach((ev)=>{
          const li = document.createElement('li');
          li.className = 'rounded-lg bg-slate-900/50 p-3 flex items-center justify-between';
          li.innerHTML = `
            <div>
              <div class="font-medium">${ev.title}</div>
              <div class="text-xs text-slate-400">${ev.time||''} ${ev.place?('‚Ä¢ '+ev.place):''}</div>
              ${ev.notes?`<div class="text-xs text-slate-400 mt-1">${ev.notes}</div>`:''}
            </div>
            <div class="flex gap-2">
              <button class="text-xs bg-slate-800 px-2 py-1 rounded" data-action="delete">Borrar</button>
            </div>`;
          li.querySelector('[data-action="delete"]').onclick = ()=>{
            const i = state.events.indexOf(ev);
            state.events.splice(i,1); persist(); renderCalendar();
          };
          ul.appendChild(li);
        });
      }
    }
    document.getElementById('prevMonth').onclick = ()=>{ cal.monthOffset--; renderCalendar(); };
    document.getElementById('nextMonth').onclick = ()=>{ cal.monthOffset++; renderCalendar(); };
    renderCalendar();

    // ===== Tasks =====
    function renderTasks(){
      const list = document.getElementById('tasksList');
      const st = document.getElementById('filterStatus').value;
      const pr = document.getElementById('filterPriority').value;
      list.innerHTML = '';
      let tasks = [...state.tasks];
      if(st!=='all'){ tasks = tasks.filter(t=> st==='done'? t.done : !t.done); }
      if(pr!=='all'){ tasks = tasks.filter(t=> t.priority===pr); }
      const P = {alta:0, media:1, baja:2};
      tasks.sort((a,b)=> (P[a.priority]-P[b.priority]) || new Date(a.created)-new Date(b.created));
      if(tasks.length===0){ list.innerHTML = '<li class="text-slate-400 text-sm">Sin tareas</li>'; return; }
      tasks.forEach((t)=>{
        const li = document.createElement('li');
        li.className = 'rounded-lg bg-slate-900/50 p-3 flex items-start justify-between gap-3';
        li.innerHTML = `
          <div class="flex items-start gap-2">
            <input type="checkbox" ${t.done?'checked':''} class="mt-1">
            <div>
              <div class="font-medium ${t.done?'line-through text-slate-400':''}">${t.title}</div>
              <div class="text-xs text-slate-400">${t.priority.toUpperCase()} ${t.due?('‚Ä¢ vence '+new Date(t.due).toLocaleString('es-CO')):''}</div>
            </div>
          </div>
          <div class="flex gap-2">
            <button class="text-xs bg-slate-800 px-2 py-1 rounded" data-action="delete">Borrar</button>
          </div>`;
        li.querySelector('input[type="checkbox"]').onchange = (e)=>{ t.done = e.target.checked; persist(); renderTasks(); };
        li.querySelector('[data-action="delete"]').onclick = ()=>{
          const i = state.tasks.indexOf(t); state.tasks.splice(i,1); persist(); renderTasks();
        };
        list.appendChild(li);
      });
    }
    renderTasks();
    document.getElementById('filterStatus').onchange = renderTasks;
    document.getElementById('filterPriority').onchange = renderTasks;

    // ===== Notes =====
    function renderNotes(){
      const grid = document.getElementById('notesGrid');
      grid.innerHTML = '';
      if(state.notes.length===0){ grid.innerHTML = '<div class="text-slate-400 text-sm">Sin notas</div>'; return; }
      state.notes.forEach((n)=>{
        const card = document.createElement('div');
        card.className = 'rounded-2xl bg-slate-900/50 p-4 border border-slate-800';
        card.innerHTML = `
          <div class="flex items-center justify-between">
            <div class="font-semibold">${n.title||'Sin t√≠tulo'}</div>
            <button class="text-xs bg-slate-800 px-2 py-1 rounded" data-action="delete">Borrar</button>
          </div>
          <div class="text-sm text-slate-300 mt-2 whitespace-pre-wrap">${n.body}</div>
          <div class="text-[10px] text-slate-500 mt-3">${new Date(n.created).toLocaleString('es-CO')}</div>`;
        card.querySelector('[data-action="delete"]').onclick = ()=>{
          const i = state.notes.indexOf(n);
          state.notes.splice(i,1); persist(); renderNotes();
        };
        grid.appendChild(card);
      });
    }
    renderNotes();

    // ===== Export/Import =====
    document.getElementById('exportBtn').onclick = ()=>{
      const data = { tasks: state.tasks, events: state.events, notes: state.notes };
      const blob = new Blob([JSON.stringify(data,null,2)], {type: 'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'kairo_backup.json'; a.click();
    };
    document.getElementById('importBtn').onclick = ()=> document.getElementById('importFile').click();
    document.getElementById('importFile').addEventListener('change', (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev)=>{ try{
        const d = JSON.parse(ev.target.result);
        state.tasks = d.tasks||[]; state.events = d.events||[]; state.notes = d.notes||[];
        persist(); renderTasks(); renderCalendar(); renderNotes(); alert('Datos importados.');
      }catch(err){ alert('Archivo inv√°lido'); } };
      reader.readAsText(file);
    });

    // ===== Modales =====
    const taskModal = document.getElementById('taskModal');
    const eventModal = document.getElementById('eventModal');
    const noteModal = document.getElementById('noteModal');
    const backdrop = document.getElementById('modalBackdrop');
    function open(m){ m.classList.remove('hidden'); backdrop.classList.remove('hidden'); }
    function close(m){ m.classList.add('hidden'); backdrop.classList.add('hidden'); }
    document.getElementById('addTaskBtn').onclick = ()=> open(taskModal);
    document.getElementById('addEventBtn').onclick = ()=>{ document.getElementById('eventDate').valueAsDate = cal.selectedDate || new Date(); open(eventModal); };
    document.getElementById('addNoteBtn').onclick = ()=> open(noteModal);
    window.closeTaskModal = ()=> close(taskModal);
    window.closeEventModal = ()=> close(eventModal);
    window.closeNoteModal = ()=> close(noteModal);

    window.saveTask = ()=>{
      const title = document.getElementById('taskTitle').value.trim();
      const priority = document.getElementById('taskPriority').value;
      const due = document.getElementById('taskDue').value;
      if(!title) return alert('Escribe un t√≠tulo.');
      const t = {title, priority, due, done:false, created:new Date()};
      state.tasks.push(t); persist(); close(taskModal); renderTasks(); scheduleTaskReminder(t);
    };
    window.saveEvent = ()=>{
      const title = document.getElementById('eventTitle').value.trim();
      const date = document.getElementById('eventDate').value;
      const time = document.getElementById('eventTime').value;
      const place = document.getElementById('eventPlace').value.trim();
      const notes = document.getElementById('eventNotes').value.trim();
      if(!title || !date) return alert('T√≠tulo y fecha son obligatorios.');
      const e = {title, date, time, place, notes, created:new Date()};
      state.events.push(e); persist(); close(eventModal); renderCalendar(); scheduleEventReminder(e);
      if(window.gapiLoaded && window.gisToken){ createGoogleEvent(e); }
    };
    window.saveNote = ()=>{
      const title = document.getElementById('noteTitle').value.trim();
      const body = document.getElementById('noteBody').value.trim();
      if(!title && !body) return alert('Escribe algo.');
      state.notes.push({title, body, created:new Date()}); persist(); close(noteModal); renderNotes();
    };

    // ===== Simple local reminders (sound + notification)
    function scheduleAllReminders(){ state.tasks.forEach(scheduleTaskReminder); state.events.forEach(scheduleEventReminder); }
    function scheduleTaskReminder(t){ if(!t.due) return; const ms=new Date(t.due).getTime()-Date.now(); if(ms<=0) return; setTimeout(()=> fire('Tarea pendiente', `${t.title} (${t.priority.toUpperCase()})`), Math.min(ms, 2147483647)); }
    function scheduleEventReminder(e){ if(!e.date) return; const when=new Date(`${e.date}T${e.time||'09:00'}`); const ms=when.getTime()-Date.now(); if(ms<=0) return; setTimeout(()=> fire('Evento', `${e.title}${e.place? ' @ '+e.place:''}`), Math.min(ms, 2147483647)); }
    if('Notification' in window && Notification.permission==='granted'){ scheduleAllReminders(); }

    // ===== Voice Commands =====
    const micBtn = document.getElementById('micBtn');
    let rec;
    micBtn.addEventListener('click', ()=>{
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR) return alert('Tu navegador no soporta reconocimiento de voz.');
      rec = new SR(); rec.lang = 'es-ES'; rec.interimResults = false; rec.maxAlternatives = 1;
      rec.onresult = (e)=>{ const text = e.results[0][0].transcript.toLowerCase(); handleVoice(text); };
      rec.onerror = ()=> alert('No pude escuchar, intenta de nuevo.');
      rec.start();
    });
    function handleVoice(text){
      if(text.startsWith('tarea ')){
        const title = text.replace('tarea ','').trim();
        const t = {title, priority:'media', done:false, created:new Date()};
        state.tasks.push(t); persist(); renderTasks(); fire('Tarea creada', title); return;
      }
      if(text.startsWith('nota ')){
        const body = text.replace('nota ','').trim();
        state.notes.push({title: 'Nota por voz', body, created:new Date()}); persist(); renderNotes(); fire('Nota guardada', body.slice(0,40)); return;
      }
      if(text.startsWith('evento ')){
        const m = text.match(/^evento (.+) el (\d{4}-\d{2}-\d{2})(?: a las (\d{2}:\d{2}))?/);
        if(m){
          const e = {title:m[1], date:m[2], time:m[3]||'09:00', place:'', notes:'', created:new Date()};
          state.events.push(e); persist(); renderCalendar(); fire('Evento creado', e.title+' '+e.date+' '+e.time);
          if(window.gapiLoaded && window.gisToken){ createGoogleEvent(e); }
          return;
        }
      }
      fire('Comando de voz', 'No entend√≠. Usa: "tarea ...", "nota ...", "evento ... el AAAA-MM-DD a las HH:MM"');
    }

    // ===== Google Calendar =====
    const googleBtn = document.getElementById('googleBtn');
    const gcalStatus = document.getElementById('gcalStatus');
    const gcalUpcoming = document.getElementById('gcalUpcoming');
    const GOOGLE_CLIENT_ID = "TU_CLIENT_ID_DE_GOOGLE.apps.googleusercontent.com";
    const SCOPES = 'https://www.googleapis.com/auth/calendar';
    let tokenClient; window.gapiLoaded=false; window.gisToken=null;

    function gapiLoaded(){
      gapi.load('client', async () => {
        await gapi.client.init({});
        await gapi.client.load('calendar', 'v3');
        window.gapiLoaded = true;
      });
    }
    window.addEventListener('load', ()=>{
      if(window.gapi) gapiLoaded();
      window.tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: GOOGLE_CLIENT_ID,
        scope: SCOPES,
        prompt: '',
        callback: (resp)=>{
          if(resp && resp.access_token){ window.gisToken = resp.access_token; gcalStatus.textContent = 'Conectado a Google Calendar'; listUpcomingEvents(); }
        }
      });
    });

    googleBtn.addEventListener('click', ()=>{
      if(!window.tokenClient){ return alert('Cargando Google... intenta en unos segundos.'); }
      window.tokenClient.requestAccessToken({prompt: 'consent'});
    });

    async function listUpcomingEvents(){
      try{
        const now = (new Date()).toISOString();
        const res = await gapi.client.calendar.events.list({
          'calendarId': 'primary', 'timeMin': now, 'showDeleted': false, 'singleEvents': true, 'maxResults': 5, 'orderBy': 'startTime'
        });
        gcalUpcoming.innerHTML = '';
        const items = res.result.items || [];
        if(items.length===0){ gcalUpcoming.innerHTML = '<li class="text-slate-400 text-sm">Sin pr√≥ximos eventos</li>'; return; }
        for(const ev of items){
          const when = ev.start.dateTime || ev.start.date;
          const li = document.createElement('li');
          li.className = 'rounded-lg bg-slate-900/50 p-3';
          li.textContent = `${ev.summary||'(sin t√≠tulo)'} ‚Äî ${when}`;
          gcalUpcoming.appendChild(li);
        }
      }catch(err){
        gcalStatus.textContent = 'Error listando eventos';
      }
    }

    async function createGoogleEvent(e){
      try{
        const start = `${e.date}T${e.time||'09:00'}:00`;
        const end = `${e.date}T${e.time||'09:30'}:00`;
        await gapi.client.calendar.events.insert({
          calendarId: 'primary',
          resource: {
            summary: e.title,
            location: e.place||'',
            description: e.notes||'',
            start: { dateTime: start },
            end: { dateTime: end }
          }
        });
        fire('Google Calendar', 'Evento creado en tu calendario');
        listUpcomingEvents();
      }catch(err){
        fire('Google Calendar', 'No pude crear el evento. Revisa permisos.');
      }
    }

    // Bootstrap
    if(!localStorage.getItem('kairo_bootstrap_voice')){
      state.tasks.push({title:'Probar micr√≥fono: "tarea comprar caf√©"', priority:'media', done:false, created:new Date()});
      state.events.push({title:'Demo KAIRO PWA', date:new Date().toISOString().slice(0,10), time:'18:00', place:'Online', notes:'', created:new Date()});
      state.notes.push({title:'Voz', body:'Di: "nota recordar llamar a Juan"', created:new Date()});
      persist(); localStorage.setItem('kairo_bootstrap_voice','1');
    }
  </script>
</body>
</html>
